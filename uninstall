#!/usr/bin/env bash

BOLD=$(tput bold)
RESET=$(tput sgr0)
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
CYAN=$(tput setaf 6)

# Function to cleanup on exit
cleanup() {
    tput cnorm  
    exit 0
}

trap cleanup EXIT INT

main() {
    tput civis
    
    package="$(dpkg-query -W -f='${Package}\n' |
            fzf -m \
            --style="full" \
            --prompt="${BOLD}${GREEN}Select A Package: ${RESET}" \
            --header="↑↓: Navigation | Tab: Select multiple package | Enter: Confirm" \
            --preview="echo -e '${BOLD}${CYAN}Package Information:${RESET}\n'; apt show {} 2>/dev/null" \
            --preview-window="top" \
            --bind="?:toggle-preview" \
            --info=inline \
            --ansi | \
        tr "\n" " "
    )"
    
    # Show cursor again
    tput cnorm
    
    # If user pressed Ctrl+C or escaped
    if [[ $? -ne 0 ]]; then
        cleanup
    fi
    
    # If packages were selected
    if [[ -n "$package" ]]; then
        echo "Selected package(s): $package"
        echo
        
        while true; do

        # Confirmation with timeout
            read -t 30 -n1 -p "Uninstall this package(s)? [Y/n/q]: " -r uninstall
            echo  # Add newline after read
            
            case "${uninstall}" in
                "" | "y" | "Y")
                    echo
                    if apt remove -y $package && apt autoremove -y; then
                        echo
                        echo "${BOLD}${GREEN}Uninstallation complete!${RESET}"
                    else
                        echo "${BOLD}${RED}Uninstallation failed!${RESET}"
                    fi
                    break
                    ;;
                "n" | "N")
                    echo
                    # Back to package selection 
                    main
                    break
                    ;;
                "q" | "Q")
                    echo "${BOLD}${CYAN}Exiting...${RESET}"
                    cleanup
                    ;;
                *)
                    echo "${BOLD}${RED}Invalid choice. Press Y(es), n(o), or q(uit)${RESET}"
                    ;;
            esac
        done
    else
        echo "${BOLD}${CYAN}No Package Selected${RESET}"
    fi
}

main
